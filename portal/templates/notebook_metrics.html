{% extends "base.html" %}
 
{% block title %}
  Notebook metrics
{% endblock %}

{% block libraries %}
<script src="https://unpkg.com/vue@3"></script>
{% endblock %}

{% block content %}
<section id="notebook-metrics">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
          <li class="breadcrumb-item"><a class="text-decoration-none" href="{{ url_for('home') }}">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Notebook metrics</li>
      </ol>
    </nav>
    <div v-if="notebooks.length > 0">
      <table class="table table-bordered mb-4">
        <thead>
          <tr>
            <th>Notebook name</th>
            <th>Username</th>
            <th>Memory request</th>
            <th>CPU request</th>
            <th>GPU request</th>
            <th>GPU memory request</th>
            <th>Hours remaining</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="notebook in notebooks">
            <td>[[ notebook.notebook_name ]]</td>
            <td>[[ notebook.username ]]</td>
            <td>[[ notebook.memory_request ]]</td>
            <td>[[ notebook.cpu_request ]]</td>
            <td>[[ notebook.gpu_request ]]</td>
            <td>[[ notebook.gpu_memory_request ]]</td>
            <td>[[ notebook.hours_remaining ]]</td>
          </tr>
        </tbody>
      </table>
      <table id="controls-table" class="table table-borderless">
        <tr>
          <td><label for="select-notebook" class="form-label my-2">Select a notebook:</label></td>
          <td>
            <select @change="event => refresh(event.target.value, null)" class="form-control" name="select-notebook" id="select-notebook">
              <option value="all-notebooks">All notebooks</option>
              <option v-for="notebook in notebooks" :value="notebook.notebook_name" v-html="notebook.notebook_name"></option>
            </select>
          </td>
          <td><label for="select-timeframe" class="form-label my-2">Select a timeframe:</label></td>
          <td>
            <select @change="event => refresh(null, event.target.value)" class="form-control" name="select-timeframe" id="select-timeframe">
              <option value="now-1h">1 hour</option>
              <option value="now-6h">6 hours</option>
              <option value="now-12h">12 hours</option>
              <option value="now-24h" selected>24 hours</option>
              <option value="now-7d">7 days</option>
            </select>
          </td>
        </tr>
      </table>
      <div>
         <iframe v-for="graph in graphs" :src="graph.url" :height="graph.height" :width="graph.width" :border="graph.border"></iframe>
      </div>
    </div>
    <p v-else>There are no notebooks in the namespace.</p>
  </div>
</section>
<script type="text/javascript">
$(document).ready(function() {
  const { createApp } = Vue

  createApp({
    delimiters: ['[[', ']]'],
    data() {
      return {
        notebooks: {{ notebooks|safe }},
        graphs: [],
        selected_notebook: null,
        selected_timeframe: null
      }
    },
    mounted() {
      this.refresh("all-notebooks", "now-24h");
    },
    methods: {
      refresh(selected_notebook, selected_timeframe) {
        this.selected_notebook = selected_notebook || this.selected_notebook;
        this.selected_timeframe = selected_timeframe || this.selected_timeframe;
        this.graphs = [];

        if (this.selected_notebook == "all-notebooks") {
          this.graphs.push({
            url: "https://atlas-kibana.mwt2.org:5601/s/analysis-facility/app/visualize?auth_provider_hint=anonymous1#/edit/f404c270-01e3-11ed-9a2c-41033d72f6b6?embed=true&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:" + this.selected_timeframe + ",to:now))&_a=(filters:!(),linked:!t,query:(language:kuery,query:''),uiState:(),vis:(aggs:!((enabled:!t,id:'1',params:(customLabel:'Memory%20usage',field:kubernetes.pod.memory.usage.bytes),schema:metric,type:avg),(enabled:!t,id:'2',params:(customLabel:'Time%20of%20day',drop_partials:!f,extendToTimeRange:!f,extended_bounds:(),field:'@timestamp',interval:auto,min_doc_count:1,scaleMetricValues:!f,timeRange:(from:now-24h%2Fh,to:now),useNormalizedEsInterval:!t,used_interval:'30m'),schema:segment,type:date_histogram),(enabled:!t,id:'3',params:(field:kubernetes.labels.instance,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!f,otherBucketLabel:Other,size:7),schema:group,type:terms)),params:(addLegend:!f,addTimeMarker:!f,addTooltip:!t,categoryAxes:!((id:CategoryAxis-1,labels:(filter:!t,show:!t,truncate:100),position:bottom,scale:(type:linear),show:!t,style:(),title:(),type:category)),detailedTooltip:!t,fittingFunction:linear,grid:(categoryLines:!f),labels:(),legendPosition:right,legendSize:large,maxLegendLines:1,palette:(name:default,type:palette),radiusRatio:9,seriesParams:!((circlesRadius:1,data:(id:'1',label:'Memory%20usage'),drawLinesBetweenPoints:!t,interpolate:linear,lineWidth:2,mode:normal,show:!t,showCircles:!t,type:line,valueAxis:ValueAxis-1)),thresholdLine:(color:%23E7664C,show:!f,style:full,value:10,width:1),times:!(),truncateLegend:!t,type:line,valueAxes:!((id:ValueAxis-1,labels:(filter:!t,rotate:0,show:!t,truncate:100),name:LeftAxis-1,position:left,scale:(mode:normal,type:linear),show:!t,style:(),title:(text:'Memory%20usage'),type:value))),title:'Memory%20usage%20for%20all%20notebooks',type:line))",
            height: "600",
            width: "100%",
            border: "0"
          });
          this.graphs.push({
            url: "https://atlas-kibana.mwt2.org:5601/s/analysis-facility/app/visualize?auth_provider_hint=anonymous1#/edit/f042e300-01e4-11ed-9a2c-41033d72f6b6?embed=true&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:" + this.selected_timeframe + ",to:now))&_a=(filters:!(),linked:!t,query:(language:kuery,query:''),uiState:(),vis:(aggs:!((enabled:!t,id:'1',params:(customLabel:'CPU%20usage%20%5Bcores%5D',field:k8s.container.cpu.usage),schema:metric,type:avg),(enabled:!t,id:'2',params:(customLabel:'Time%20of%20day',drop_partials:!f,extendToTimeRange:!f,extended_bounds:(),field:'@timestamp',interval:auto,min_doc_count:1,scaleMetricValues:!f,timeRange:(from:now-24h%2Fh,to:now),useNormalizedEsInterval:!t,used_interval:'30m'),schema:segment,type:date_histogram),(enabled:!t,id:'3',params:(field:kubernetes.labels.instance,missingBucket:!f,missingBucketLabel:Missing,order:desc,orderBy:'1',otherBucket:!f,otherBucketLabel:Other,size:5),schema:group,type:terms)),params:(addLegend:!f,addTimeMarker:!f,addTooltip:!t,categoryAxes:!((id:CategoryAxis-1,labels:(filter:!t,show:!t,truncate:100),position:bottom,scale:(type:linear),show:!t,style:(),title:(),type:category)),detailedTooltip:!t,fittingFunction:linear,grid:(categoryLines:!f),labels:(),legendPosition:right,legendSize:large,maxLegendLines:1,palette:(name:default,type:palette),radiusRatio:9,seriesParams:!((circlesRadius:1,data:(id:'1',label:'CPU%20usage%20%5Bcores%5D'),drawLinesBetweenPoints:!t,interpolate:linear,lineWidth:2,mode:normal,show:!t,showCircles:!t,type:line,valueAxis:ValueAxis-1)),thresholdLine:(color:%23E7664C,show:!f,style:full,value:10,width:1),times:!(),truncateLegend:!t,type:line,valueAxes:!((id:ValueAxis-1,labels:(filter:!t,rotate:0,show:!t,truncate:100),name:LeftAxis-1,position:left,scale:(mode:normal,type:linear),show:!t,style:(),title:(text:'CPU%20usage%20%5Bcores%5D'),type:value))),title:'CPU%20usage%20for%20all%20notebooks',type:line))",
            height: "600",
            width: "100%",
            border: "0"
          });
        }
        else {
          this.graphs.push({
            url: "https://atlas-kibana.mwt2.org:5601/s/analysis-facility/app/visualize?auth_provider_hint=anonymous1#/edit/69c03760-1f21-11ed-afcf-d91dad577662?embed=true&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:" + this.selected_timeframe + ",to:now))&_a=(filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'960f8933-5f24-51a1-9475-3e0ba79c9b10',key:kubernetes.labels.notebook-id,negate:!f,params:(query:" + this.selected_notebook + "),type:phrase),query:(match_phrase:(kubernetes.labels.notebook-id:" + this.selected_notebook + ")))),linked:!t,query:(language:kuery,query:''),uiState:(),vis:(aggs:!((enabled:!t,id:'1',params:(customLabel:'CPU%20usage%20%5Bcores%5D',field:k8s.container.cpu.usage),schema:metric,type:avg),(enabled:!t,id:'2',params:(customLabel:'Time%20of%20day',drop_partials:!f,extendToTimeRange:!f,extended_bounds:(),field:'@timestamp',interval:auto,min_doc_count:1,scaleMetricValues:!f,timeRange:(from:now-24h%2Fh,to:now),useNormalizedEsInterval:!t,used_interval:'30m'),schema:segment,type:date_histogram)),params:(addLegend:!f,addTimeMarker:!f,addTooltip:!f,categoryAxes:!((id:CategoryAxis-1,labels:(filter:!t,show:!t,truncate:100),position:bottom,scale:(type:linear),show:!t,style:(),title:(),type:category)),detailedTooltip:!f,fittingFunction:linear,grid:(categoryLines:!f),labels:(),legendPosition:right,maxLegendLines:1,palette:(name:default,type:palette),radiusRatio:9,seriesParams:!((circlesRadius:1,data:(id:'1',label:'CPU%20usage%20%5Bcores%5D'),drawLinesBetweenPoints:!t,interpolate:linear,lineWidth:2,mode:normal,show:!t,showCircles:!t,type:line,valueAxis:ValueAxis-1)),thresholdLine:(color:%23E7664C,show:!f,style:full,value:10,width:1),times:!(),truncateLegend:!f,type:line,valueAxes:!((id:ValueAxis-1,labels:(filter:!t,rotate:0,show:!t,truncate:100),name:LeftAxis-1,position:left,scale:(mode:normal,type:linear),show:!t,style:(),title:(text:'CPU%20usage%20%5Bcores%5D'),type:value))),title:'CPU%20usage%20for%20a%20single%20notebook%20(version%202.0)',type:line))",
            height: "600",
            width: "100%",
            border: "0"
          });
          this.graphs.push({
            url: "https://atlas-kibana.mwt2.org:5601/s/analysis-facility/app/visualize?auth_provider_hint=anonymous1#/edit/5840b190-1f21-11ed-afcf-d91dad577662?embed=true&_g=(filters:!(),query:(language:kuery,query:''),refreshInterval:(pause:!t,value:0),time:(from:" + this.selected_timeframe + ",to:now))&_a=(filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'960f8933-5f24-51a1-9475-3e0ba79c9b10',key:kubernetes.labels.notebook-id,negate:!f,params:(query:" + this.selected_notebook + "),type:phrase),query:(match_phrase:(kubernetes.labels.notebook-id:" + this.selected_notebook + ")))),linked:!t,query:(language:kuery,query:''),uiState:(),vis:(aggs:!((enabled:!t,id:'1',params:(customLabel:'Memory%20usage',field:kubernetes.pod.memory.usage.bytes),schema:metric,type:avg),(enabled:!t,id:'2',params:(customLabel:'Time%20of%20day',drop_partials:!f,extendToTimeRange:!f,extended_bounds:(),field:'@timestamp',interval:auto,min_doc_count:1,scaleMetricValues:!f,timeRange:(from:now-24h%2Fh,to:now),useNormalizedEsInterval:!t,used_interval:'30m'),schema:segment,type:date_histogram)),params:(addLegend:!f,addTimeMarker:!f,addTooltip:!t,categoryAxes:!((id:CategoryAxis-1,labels:(filter:!t,show:!t,truncate:100),position:bottom,scale:(type:linear),show:!t,style:(),title:(),type:category)),detailedTooltip:!t,fittingFunction:linear,grid:(categoryLines:!f),labels:(),legendPosition:right,maxLegendLines:1,palette:(name:default,type:palette),radiusRatio:9,seriesParams:!((circlesRadius:1,data:(id:'1',label:'Memory%20usage'),drawLinesBetweenPoints:!t,interpolate:linear,lineWidth:2,mode:normal,show:!t,showCircles:!t,type:line,valueAxis:ValueAxis-1)),thresholdLine:(color:%23E7664C,show:!f,style:full,value:10,width:1),times:!(),truncateLegend:!t,type:line,valueAxes:!((id:ValueAxis-1,labels:(filter:!t,rotate:0,show:!t,truncate:100),name:LeftAxis-1,position:left,scale:(mode:normal,type:linear),show:!t,style:(),title:(text:'Memory%20usage'),type:value))),title:'Memory%20usage%20for%20a%20single%20notebook%20(version%202.0)',type:line))",
            height: "600",
            width: "100%",
            border: "0"
          });
          this.graphs.push({
            url: "https://atlas-kibana.mwt2.org:5601/s/analysis-facility/app/visualize?auth_provider_hint=anonymous1#/edit/934c92f0-1f2a-11ed-afcf-d91dad577662?embed=true&_g=(filters:!(),query:(language:kuery,query:''),refreshInterval:(pause:!t,value:0),time:(from:" + this.selected_timeframe + ",to:now))&_a=(filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'960f8933-5f24-51a1-9475-3e0ba79c9b10',key:kubernetes.labels.notebook-id,negate:!f,params:(query:" + this.selected_notebook + "),type:phrase),query:(match_phrase:(kubernetes.labels.notebook-id:" + this.selected_notebook + ")))),linked:!t,query:(language:kuery,query:''),uiState:(),vis:(aggs:!((enabled:!t,id:'1',params:(customLabel:'Bytes%20transmitted',field:kubernetes.pod.network.tx.bytes),schema:metric,type:avg),(enabled:!t,id:'2',params:(customLabel:'Time%20of%20day',drop_partials:!f,extendToTimeRange:!f,extended_bounds:(),field:'@timestamp',interval:auto,min_doc_count:1,scaleMetricValues:!f,timeRange:(from:now-24h%2Fh,to:now),useNormalizedEsInterval:!t,used_interval:'30m'),schema:segment,type:date_histogram)),params:(addLegend:!f,addTimeMarker:!f,addTooltip:!t,categoryAxes:!((id:CategoryAxis-1,labels:(filter:!t,show:!t,truncate:100),position:bottom,scale:(type:linear),show:!t,style:(),title:(),type:category)),detailedTooltip:!t,fittingFunction:linear,grid:(categoryLines:!f),labels:(),legendPosition:right,maxLegendLines:1,palette:(name:default,type:palette),radiusRatio:9,seriesParams:!((circlesRadius:1,data:(id:'1',label:'Bytes%20transmitted'),drawLinesBetweenPoints:!t,interpolate:linear,lineWidth:2,mode:normal,show:!t,showCircles:!t,type:line,valueAxis:ValueAxis-1)),thresholdLine:(color:%23E7664C,show:!f,style:full,value:10,width:1),times:!(),truncateLegend:!t,type:line,valueAxes:!((id:ValueAxis-1,labels:(filter:!t,rotate:0,show:!t,truncate:100),name:LeftAxis-1,position:left,scale:(mode:normal,type:linear),show:!t,style:(),title:(text:'Bytes%20transmitted'),type:value))),title:'Network%20activity%20for%20a%20single%20notebook%20(version%202.0)',type:line))",
            height: "600",
            width: "100%",
            border: "0"
          });
        }
      }
    }
  }).mount("#notebook-metrics");
 });
</script>
{% endblock %}