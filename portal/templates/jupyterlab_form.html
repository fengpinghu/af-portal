{% extends "base.html" %}

{% block title %} Configure notebook {% endblock %}

{% block assets %}
<script src="https://unpkg.com/vue@3"></script>
{% endblock %}

{% block body %}
<section id="jupyterlab-form">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a class="text-decoration-none" href="{{ url_for('home') }}">Home</a></li>
                <li class="breadcrumb-item"><a class="text-decoration-none"
                        href="{{ url_for('open_jupyterlab') }}">JupyterLab</a></li>
                <li class="breadcrumb-item active" aria-current="page">Configure</li>
            </ol>
        </nav>
        <div class="card col-sm-6 mx-auto">
            <img id="jupyterlab-logo" class="card-img-top" src="{{url_for('static', filename='img/jupyter-lab-logo.png')}}" alt="JupyterLab">
            <div class="card-body">
                <h5 class="card-title mb-3">Create a Jupyter notebook with a machine learning setup</h5>
                <form id="configure-form" @change="validateForm()" action="{{ url_for('deploy_notebook') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <label for="notebook-name" class="form-label my-2">Notebook name</label>
                        </div>
                        <div class="col-sm-8">
                            <input id="notebook-name" type="text" class="form-control" name="notebook-name" value="{{ notebook_name }}" @keydown="handleNameChange" required/>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <label for="cpu" class="form-label my-2">CPU cores</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" name="cpu" min=1 max=4 value=1 required/>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4">                       
                            <label for="memory" class="form-label my-2">Memory</label>
                        </div>
                        <div class="col-sm-8">                           
                            <input type="number" class="form-control" name="memory" min=1 max=32 value=2 required/>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4">  
                            <label for="gpu" class="form-label my-2">
                                GPU instances
                                <a class="text-decoration-none" data-bs-toggle="modal" href="#gpu-instances" role="button">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            </label>
                        </div>
                        <div class="col-sm-8">  
                           <input v-model="instances" type="number" class="form-control" name="gpu" id="gpu" min="0" max="4" value="0" required/>
                        </div>
                    </div>
                    <div v-if="gpus" v-show="instances > 0" class="row mb-2">
                        <div class="col-sm-4">
                            <label for="gpu-memory" class="form-label my-2">
                                GPU memory (MB)
                                <a class="text-decoration-none" data-bs-toggle="modal" href="#gpu-memory" role="button">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            </label>
                        </div>
                        <div class="col-sm-8">
                            <select name="gpu-memory" class="form-control">
                                <option v-for="gpu in gpus" :value="gpu.memory">[[ gpu.memory ]]</option>
                            </select>
                        </div>                      
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <label for="duration" class="form-label my-2">Duration (hours)</label>
                        </div>
                        <div class="col-sm-8">
                            <input type="number" name="duration" class="form-control col" min=1 max=168 value=8 required/>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-sm-4">
                            <label for="image" class="form-label my-2">
                                Image
                                <a class="text-decoration-none" href="#docker-image" data-bs-toggle="modal" role="button">
                                    <i class="fas fa-info-circle"></i>
                                </a>
                            </label>
                        </div>
                        <div class="col-sm-8">
                            <select name="image" class="form-control">
                                <option value="hub.opensciencegrid.org/usatlas/ml-platform:latest">ml-platform:latest</option>
                                <option value="hub.opensciencegrid.org/usatlas/ml-platform:conda">ml-platform:conda</option>
                                <option value="hub.opensciencegrid.org/usatlas/ml-platform:julia">ml-platform:julia</option>
                                <option value="hub.opensciencegrid.org/usatlas/ml-platform:lava">ml-platform:lava</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" type="submit" :disabled="!valid" onclick="loader(true)">Create notebook</button>
                </form>
            </div>
        </div>
        <div id="gpu-memory" class="modal fade" role="dialog">
            <div class="modal-dialog" style="max-width: 600px">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Selecting GPU memory</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div v-if="gpus" class="modal-body">
                        <p>Here is a table of our GPU products.</p>
                        <table class="table table-hover table-bordered nowrap w-100">
                            <thead>
                                <tr>
                                    <th>GPU Product</th>
                                    <th>Count</th>
                                    <th>Avail.</th>
                                    <th>Memory (MB)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="gpu in gpus">
                                    <td>[[ gpu.product ]]</td>
                                    <td>[[ gpu.count ]]</td>
                                    <td>[[ gpu.available ]]</td>
                                    <td>[[ gpu.memory ]]</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else class="modal-body">
                        Loading...
                        <span class="spinner-border spinner-border-sm text-dark ms-2" role="status"></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="gpu-instances" class="modal fade" role="dialog">
            <div class="modal-dialog" style="max-width: 600px">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Selecting GPU instances</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            The AF cluster has a variety of GPUs you can choose from. Each GPU can be partitioned into
                            instances. You can have many instances running in parallel.
                        </p>
                        <p>
                            Please select the number of GPU instances you would like to request. You can select any
                            number from 0 to 4.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="docker-image" class="modal fade">
            <div class="modal-dialog" style="max-width: 600px">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Selecting a Docker image</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            Users can choose between two images: One with full anaconda <code>(ivukotic/ml_platform:conda)</code> 
                            and one with NVidia GPU and ROOT support <code>(ivukotic/ml_platform:latest)</code>.
                        </p>
                        <p>
                            The later has most of the ML packages (Tensorflow, Keras, ScikitLearn, ...) preinstalled, and
                            a small tutorial with code examples in <code>/ML_platform_tests/tutorial</code>.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script type="text/javascript">
$(document).ready(function() {
    const { createApp } = Vue

    createApp({
        delimiters: ["[[", "]]"],
        data() {
            return {
                gpus: null,
                instances: 0,
                valid: false
            }
        },
        async mounted() {
            this.validateForm();
            const response = await fetch("{{ url_for('get_gpus') }}");
            const json = await response.json()
            this.gpus = json.gpus
        },
        methods: {
            handleNameChange(event) {
                if (!/[a-zA-Z0-9._-]/.test(event.key)) {
                    event.preventDefault();
                    event.returnValue = false;
                }
            },
            validateForm() {
                console.log("Validate form called.");
                $("#configure-form").validate();
                this.valid = $("#configure-form").valid();
            }
        }
    }).mount("#jupyterlab-form");
});    
</script>
{% endblock %}