{%extends "base.html"%}

{%block title%}
  JupyterLab
{%endblock%}

{% block libraries %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.dataTables.min.css') }}" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
{% endblock %}

{% block content %}
<section id="jupyterlab">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a class="text-decoration-none" href="{{ url_for('home') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">JupyterLab</li>
            </ol>
        </nav>
        <a href="{{ url_for('configure_notebook') }}" class="btn btn-sm btn-primary mb-4">Create notebook</a>
        <div class="fs14">
          <table id="notebooks" class="table nowrap w-100">
              <thead class="text-muted">
                <tr>
                    <th>Notebook</th>
                    <th>Status</th>
                    <th>Creation date</th>
                    <th>Expiration date</th>
                    <th></th>
                </tr>
              </thead>
          </table>
        </div>
    </div>
</section>
<script type="text/javascript">
$(document).ready(function() {
  const table = $("#notebooks").DataTable({
    processing: true,
    ajax: { url: "{{ url_for('get_notebooks') }}", dataSrc: "notebooks" },
    columns: [
      { data: "notebook_id" },
      { data: "status" },
      { data: "creation_date", type: "date" },
      { data: "expiration_date", type: "date" },
      { data: null, orderable: false}
    ],
    columnDefs: [
      {
        targets: 0,
        render: function(data, type, row) {
          if (row.status.current == "Ready") {
            return "<a href='" + row["url"] + "' class='text-decoration-none' target='_blank'>" + data + "</a>";
          }
          return data;
        },
        width: "24%"
      },
      {
        targets: 1,
        render: function(data, type, row) {
          if (data["history"].length > 0) {
            let html = "<a class='text-decoration-none' data-bs-toggle='collapse' role='button' aria-expanded='false' aria-controls='" + row.notebook_id + "_status-list' href='#" + row.notebook_id + "_status-list'>";
              html += data["current"];
              html += "</a>";
              html += "<ul class='collapse list-unstyled mb-0' id='" + row.notebook_id + "_status-list'>";
              for (let i = 0; i < data["history"].length; i++) {
                html += "<li>" + data["history"][i] + "</li>";
              }
              html += "</ul>";
              return html;
          }
          return data["current"];
        },
        width: "24%"
      },
      {
        targets: 2,
        width: "24%"
      },
      {
        targets: 3,
        width: "24%"
      },
      {
        targets: 4,
        render: function(data, type, row) {
          if (row.status.current == "Removing notebook...") {
            return "<i class='fa-regular fa-trash-can'></i>";
          }
          return "<a class='text-decoration-none remove-button' style='cursor: pointer'><i class='fa-regular fa-trash-can'></i></a>";
        },
        width: "4%"
      }
    ]
  });

  function allReady(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i].status.current != "Ready") {
        return false;
      }
    }
    return true;
  }

  table.on("xhr", function() {
    const notebooks = table.ajax.json().notebooks;
    if (!allReady(notebooks)) {
      setTimeout(table.ajax.reload, 10000);
    }
  });

  table.on("click", "a.remove-button", function() {
    const row = table.row($(this).parents("tr"));
    const rowData = row.data();
    $.get("{{request.base_url}}/remove/" + rowData.notebook_id, function(resp) {
      if (resp["success"]) {
        rowData.status.current = "Removing notebook...";
        rowData.status.history = [];
        row.data(rowData).draw(true);
        table.ajax.reload();
      }
    });
  });
});
</script>
{% endblock %}