{%extends "base.html"%}

{%block title%}
  JupyterLab
{%endblock%}

{% block libraries %}
<script src="https://unpkg.com/vue@3"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.dataTables.min.css') }}" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
{% endblock %}

{% block content %}
<section id="jupyterlab">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a class="text-decoration-none" href="{{ url_for('home') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">JupyterLab</li>
            </ol>
        </nav>
        <a href="{{ url_for('configure_notebook') }}" class="btn btn-sm btn-primary mb-4">Create notebook</a>
        <div v-if="notebooks.length > 0" class="fs14">
          <table id="notebooks" class="table nowrap w-100">
              <thead class="text-muted">
                <tr>
                    <th>Notebook</th>
                    <th>Status</th>
                    <th>Creation date</th>
                    <th>Expiration date</th>
                    <th></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="notebook in notebooks">
                    <td v-if="notebook.ready">
                      <a :href="notebook.url" class="text-decoration-none" target="_blank">
                        [[ notebook.name ]]
                      </a>
                    </td>
                    <td v-else>[[ notebook.name ]]</td>
                    <td v-if="notebook.closing">[[ notebook.status ]]</td>
                    <td v-else>            
                      <a class="text-decoration-none" data-bs-toggle="collapse" :href="notebook.status_messages_href" role="button" aria-expanded="false" aria-controls="collapseExample">
                        [[ notebook.status ]]
                      </a>              
                      <ul class="collapse list-unstyled mb-0" :id="notebook.status_messages_id">
                        <li v-for="status_message in notebook.history">[[ status_message ]]</li>
                      </ul>
                    </td>
                    <td>[[ notebook.creation_date ]]</td>
                    <td>[[ notebook.expiration_date ]]</td>
                    <td v-if="notebook.closing"><i class='fa-regular fa-trash-can'></i></td>
                    <td v-else>
                      <a @click="removeNotebook(notebook)" class="text-decoration-none" role="button">
                        <i class='fa-regular fa-trash-can'></i>
                      </a>
                    </td>
                </tr>
              </tbody>
          </table>
        </div>
        <p v-else>You have no notebooks currently running.</p>
    </div>
</section>
<script type="text/javascript">
$(document).ready(function() {
  const { createApp } = Vue

  createApp({
    delimiters: ['[[', ']]'],
    data() {
      return {
        notebooks: []
      }
    },
    mounted() {
      var notebooks = {{ notebooks|safe }};
      this.updateModel(notebooks);

      $("#notebooks").DataTable({
        columnDefs: [
          { "targets": 2, type: "date" }, 
          { "targets": 3, type: "date" }
        ]
      });

      if (!this.finishedUpdating())
        this.makeAjaxRequests();
    },
    methods: {
        updateModel(notebooks) {
          this.notebooks = [];
          for (var i = 0; i < notebooks.length; i++) {
            notebook = {
              name: notebooks[i].notebook_name,
              url: notebooks[i].url,
              status: notebooks[i].status.current,
              history: notebooks[i].status.history,
              status_messages_href: "#status_messages_" + notebooks[i].notebook_name,
              status_messages_id: "status_messages_" + notebooks[i].notebook_name,
              creation_date: notebooks[i].creation_date,
              expiration_date: notebooks[i].expiration_date,
              ready: notebooks[i].status.current == "Ready",
              closing: notebooks[i].status.current == "Removing notebook..."
            }
            this.notebooks[i] = notebook;
          }
        },
        makeAjaxRequests() {
            var self = this;
            var counter = 0;
            var id = setInterval(function() {
                if (++counter > 30) {
                  clearInterval(id);
                  return;
                }
                $.get("{{ url_for('get_notebooks') }}", function(notebooks) {
                  self.updateModel(notebooks);
                  if (self.finishedUpdating())
                    clearInterval(id);
                });
            }, 5000);
        },
        finishedUpdating() {
          for (var i = 0; i < this.notebooks.length; i++) 
            if (!this.notebooks[i].ready) 
              return false;
          return true;
        },
        removeNotebook(notebook) {
          var self = this;
          $.get("{{ request.base_url }}/remove/" + notebook.name, function(resp) {
            if (resp["success"]) {
              notebook.status = "Removing notebook...";
              notebook.closing = true;
              notebook.ready = false;
              self.makeAjaxRequests();
            }
          });
        }
    }
  }).mount("#jupyterlab");
});
</script>
{% endblock %}